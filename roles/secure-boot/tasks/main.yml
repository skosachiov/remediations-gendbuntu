- name: Secure boot utils are present @secure_boot_utils_present
  ignore_errors: "{{ansible_check_mode}}"
  package:
    name:
      - mokutil
      - efitools
  when: var_secure_boot
  tags:
    - ws
    - secure_boot_utils_present

- name: Get secure boot status @get_secure_boot_status
  ignore_errors: "{{ansible_check_mode}}"
  block:
    - name: Check Secure Boot status with mokutil
      command:  mokutil --sb-state
      register: mokutil_output
      changed_when: false
    - name: Set secure_boot variable
      set_fact:
        var_secure_boot_status: "{{ true if 'SecureBoot enabled' in mokutil_output.stdout else false }}"
  when: var_secure_boot
  tags:
    - ws
    - get_secure_boot_status

- name: Secure boot keys are updated @sb_keys are_updated
  block:
    - name: Check PK
      command: mokutil --pk
      register: result
    - name: Update PK
      command: efi-updatevar -f {{playbook_dir}}/assets/esl/PK.auth PK
      when: result.stdout | trim == ""
    - name: Check KEK
      command: mokutil --kek
      register: result
    - name: Update KEK
      command: efi-updatevar -f {{playbook_dir}}/assets/esl/KEK.auth KEK
      when: result.stdout | trim == ""
    - name: Check DB
      command: mokutil --db
      register: result
    - name: Update DB
      command: efi-updatevar -f {{playbook_dir}}/assets/esl/DB.auth db
      when: result.stdout | trim == ""            
  when: var_secure_boot and not var_secure_boot_status
  tags:
    - ws
    - sb_keys are_updated

- name: Linux-uki installed
  debug:
    msg: "This is a dummy task, execution reached this point."
  when: var_secure_boot

- name: Check cryptenroll status with detailed output
  shell: |
    for device in $(lsblk -n -o NAME,FSTYPE | grep crypto_LUKS | cut -d' ' -f1); do
      echo "=== Device: /dev/$device ==="
      systemd-cryptenroll --tpm2-device=list "/dev/$device" 2>/dev/null || echo "No TPM2 enrollment"
    done
  register: cryptenroll_status
  changed_when: false

- name: Force cryptenroll if uki installed
  debug:
    msg: "This is a dummy task, execution reached this point."
  when: cryptenroll_status != var_force_cryptenroll
